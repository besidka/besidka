name: Build

on:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: production
      worker_name_prefix:
        required: false
        type: string
        default: ''
        description: "Optional commit hash for versioned deployment (e.g., abc1234)"
      pr_number:
        required: false
        type: number
        description: "PR number for alias (e.g., 113 for pr-113-besidka-preview.chernenko.workers.dev)"
    outputs:
      url:
        description: "Deployment URL"
        value: ${{ jobs.build.outputs.deployment-url }}
      preview-hash-url:
        description: "Version preview URL (auto hash)"
        value: ${{ jobs.build.outputs.preview-hash-url }}
      preview-alias-url:
        description: "Version preview alias URL (PR number)"
        value: ${{ jobs.build.outputs.preview-alias-url }}
      bundle-size:
        description: "Bundle size information"
        value: ${{ jobs.build.outputs.bundle-size }}
      duration:
        description: "Total duration"
        value: ${{ jobs.build.outputs.duration }}
      test-unit-time:
        description: "Unit tests duration"
        value: ${{ jobs.build.outputs.test-unit-time }}
      test-integration-time:
        description: "Integration tests duration"
        value: ${{ jobs.build.outputs.test-integration-time }}
      test-e2e-time:
        description: "E2E tests duration"
        value: ${{ jobs.build.outputs.test-e2e-time }}
      build-time:
        description: "Nuxt build duration"
        value: ${{ jobs.build.outputs.build-time }}
      deploy-time:
        description: "Cloudflare deploy duration"
        value: ${{ jobs.build.outputs.deploy-time }}
    secrets:
      CLOUDFLARE_ACCOUNT_ID:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true
      
jobs:
  build:
    name: "Build the application"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}
      preview-hash-url: ${{ steps.preview-urls.outputs.hash-url }}
      preview-alias-url: ${{ steps.preview-urls.outputs.alias-url }}
      bundle-size: ${{ steps.bundle-size.outputs.bundle-size }}
      duration: ${{ steps.calculate-duration.outputs.duration }}
      test-unit-time: ${{ steps.test-unit.outputs.duration }}
      test-integration-time: ${{ steps.test-integration.outputs.duration }}
      test-e2e-time: ${{ steps.test-e2e.outputs.duration }}
      build-time: ${{ steps.build-app.outputs.duration }}
      deploy-time: ${{ steps.deploy-app.outputs.duration }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Record start time
        id: start-time
        run: echo "start-time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate affected test detection on PRs
          fetch-depth: 0

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Run TypeScript type checks
        run: |
          pnpm run dev:prepare
          pnpm run typecheck

      - name: Run unit tests (PR - affected only)
        if: ${{ github.event_name == 'pull_request' }}
        id: test-unit-pr
        run: |
          START=$(date +%s)
          node scripts/test-affected.mjs --base=origin/${{ github.base_ref }} --type=unit
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… Affected unit tests completed in ${DURATION}s"

      - name: Run all unit tests (main)
        if: ${{ github.event_name != 'pull_request' }}
        id: test-unit-main
        run: |
          START=$(date +%s)
          pnpm run test:unit
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… All unit tests completed in ${DURATION}s"

      - name: Set unit test duration output
        id: test-unit
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "duration=${{ steps.test-unit-pr.outputs.duration }}" >> $GITHUB_OUTPUT
          else
            echo "duration=${{ steps.test-unit-main.outputs.duration }}" >> $GITHUB_OUTPUT
          fi

      - name: Run integration tests (PR - affected only)
        if: ${{ github.event_name == 'pull_request' }}
        id: test-integration-pr
        run: |
          START=$(date +%s)
          node scripts/test-affected.mjs --base=origin/${{ github.base_ref }} --type=integration
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… Affected integration tests completed in ${DURATION}s"

      - name: Run all integration tests (main)
        if: ${{ github.event_name != 'pull_request' }}
        id: test-integration-main
        run: |
          START=$(date +%s)
          pnpm run test:integration
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… All integration tests completed in ${DURATION}s"

      - name: Set integration test duration output
        id: test-integration
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "duration=${{ steps.test-integration-pr.outputs.duration }}" >> $GITHUB_OUTPUT
          else
            echo "duration=${{ steps.test-integration-main.outputs.duration }}" >> $GITHUB_OUTPUT
          fi

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run E2E tests (PR - affected only)
        if: ${{ github.event_name == 'pull_request' }}
        id: test-e2e-pr
        run: |
          START=$(date +%s)
          node scripts/test-affected.mjs --base=origin/${{ github.base_ref }} --type=e2e
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… Affected E2E tests completed in ${DURATION}s"
        env:
          CI: true
          #DEBUG: pw:webserver
          #NODE_OPTIONS: --trace-warnings

      - name: Run all E2E tests (main)
        if: ${{ github.event_name != 'pull_request' }}
        id: test-e2e-main
        run: |
          START=$(date +%s)
          pnpm run test:e2e
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… All E2E tests completed in ${DURATION}s"
        env:
          CI: true
          #DEBUG: pw:webserver
          #NODE_OPTIONS: --trace-warnings

      - name: Set E2E test duration output
        id: test-e2e
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "duration=${{ steps.test-e2e-pr.outputs.duration }}" >> $GITHUB_OUTPUT
          else
            echo "duration=${{ steps.test-e2e-main.outputs.duration }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always() && (steps.test-e2e-pr.outcome != 'skipped' || steps.test-e2e-main.outcome != 'skipped')
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Build application
        id: build-app-run
        env:
          ROLLDOWN_OPTIONS_VALIDATION: loose
        run: |
          START=$(date +%s)
          pnpm run build 2>&1 | tee build-output.log
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… Build completed in ${DURATION}s"

      - name: Set build time output
        id: build-app
        run: echo "duration=${{ steps.build-app-run.outputs.duration }}" >> $GITHUB_OUTPUT

      - name: Extract and output bundle size
        id: bundle-size-extract
        run: |
          SIZE_INFO=$(grep -E "Total size:.*MB.*gzip" build-output.log | sed 's/\x1b\[[0-9;]*m//g' | sed 's/Î£ Total size: //' || echo "Size information not found")
          echo "Bundle Size: $SIZE_INFO"
          echo "bundle-size=$SIZE_INFO" >> $GITHUB_OUTPUT

      - name: Set bundle size output
        id: bundle-size
        run: echo "bundle-size=${{ steps.bundle-size-extract.outputs.bundle-size }}" >> $GITHUB_OUTPUT

      - name: Verify build output exists
        run: |
          echo "Checking if .output/ directory exists..."
          if [ ! -d ".output" ]; then
            echo "âŒ ERROR: .output/ directory not found!"
            echo "Build may have failed silently."
            echo ""
            echo "Current directory contents:"
            ls -la
            echo ""
            echo "Checking for common build output locations:"
            ls -la dist/ 2>/dev/null || echo "No dist/ directory"
            ls -la build/ 2>/dev/null || echo "No build/ directory"
            exit 1
          fi

          echo "âœ… .output/ directory exists"
          echo ""
          echo "Contents of .output/:"
          ls -lah .output/
          echo ""
          echo "Disk usage:"
          du -sh .output/

      - name: Record deploy start time
        id: deploy-start
        run: echo "start-time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Prepare deployment command
        id: deploy-cmd
        run: |
          if [ -n "${{ inputs.worker_name_prefix }}" ]; then
            PR_NUM=${{ inputs.pr_number || 'dev' }}
            PR_URL="https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}"
            echo "command=versions upload --preview-alias pr-${PR_NUM} --message \"${PR_URL}\"" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.environment }}" == "production" ]; then
            echo "command=deploy --env production" >> $GITHUB_OUTPUT
          else
            echo "command=deploy" >> $GITHUB_OUTPUT
          fi

      - name: Deploy app to Cloudflare Workers via Wrangler
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          packageManager: pnpm
          wranglerVersion: ${{ vars.WRANGLER_VERSION || '4.62.0' }}
          command: ${{ steps.deploy-cmd.outputs.command }}

      - name: Extract preview URLs from deployment output
        id: preview-urls
        run: |
          # The deployment-url output contains the main deployment URL
          # For versions upload, this will be the auto-hash URL
          HASH_URL="${{ steps.deploy.outputs.deployment-url }}"

          # Construct alias URL (PR-based)
          if [ -n "${{ inputs.pr_number }}" ]; then
            ALIAS_URL="https://pr-${{ inputs.pr_number }}-besidka-preview.chernenko.workers.dev"
          else
            ALIAS_URL=""
          fi

          echo "hash-url=${HASH_URL}" >> $GITHUB_OUTPUT
          echo "alias-url=${ALIAS_URL}" >> $GITHUB_OUTPUT

      - name: Calculate deploy time
        id: deploy-app
        run: |
          START=${{ steps.deploy-start.outputs.start-time }}
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… Deploy completed in ${DURATION}s"

      - name: Print deployed URL
        env:
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment-url }}
        run: echo $DEPLOYMENT_URL

      - name: Calculate total duration and print summary
        id: calculate-duration
        run: |
          START_TIME=${{ steps.start-time.outputs.start-time }}
          END_TIME=$(date +%s)
          TOTAL_DURATION=$((END_TIME - START_TIME))
          MINUTES=$((TOTAL_DURATION / 60))
          SECONDS=$((TOTAL_DURATION % 60))
          if [ $MINUTES -gt 0 ]; then
            DURATION_FORMAT="${MINUTES}m ${SECONDS}s"
          else
            DURATION_FORMAT="${SECONDS}s"
          fi
          echo "duration=$DURATION_FORMAT" >> $GITHUB_OUTPUT

          # Print beautiful summary
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    BUILD SUMMARY                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                            â•‘"
          echo "â•‘  ğŸ“Š Test Results:                                          â•‘"
          echo "â•‘     â€¢ Unit tests:        ${{ steps.test-unit.outputs.duration }}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘     â€¢ Integration tests: ${{ steps.test-integration.outputs.duration }}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘     â€¢ E2E tests:         ${{ steps.test-e2e.outputs.duration }}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘                                                            â•‘"
          echo "â•‘  ğŸ—ï¸  Build Process:                                        â•‘"
          echo "â•‘     â€¢ Nuxt build:        ${{ steps.build-app.outputs.duration }}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘     â€¢ Bundle size:       ${{ steps.bundle-size.outputs.bundle-size }}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘                                                            â•‘"
          echo "â•‘  ğŸš€ Deployment:                                            â•‘"
          echo "â•‘     â€¢ Deploy time:       ${{ steps.deploy-app.outputs.duration }}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘     â€¢ URL:               ${{ steps.deploy.outputs.deployment-url }}" | awk '{printf "%-60sâ•‘\n", $0}' | head -c 66
          echo "â•‘                                                            â•‘"
          echo "â•‘  â±ï¸  Total Time:          ${DURATION_FORMAT}" | awk '{printf "%-60sâ•‘\n", $0}'
          echo "â•‘                                                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""