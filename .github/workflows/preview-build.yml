name: Preview Build

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
      - '.ai/**'
      - '.claude/**'
      - '.github/**'
      - '.husky/**'
      - '.vscode/**'
      - 'docs/**'
      - 'lib/**'
      - 'scripts/**'
      - 'commitlint.config.ts'
      - '.*rc'

concurrency:
  group: preview-build-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-pr-state:
    name: Check PR state
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check if PR is still open
        run: |
          STATE=$(gh pr view ${{ github.event.pull_request.number }} --json state --jq '.state')
          if [ "$STATE" != "OPEN" ]; then
            echo "PR is $STATE, canceling workflow"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

  check-latest-commit:
    name: Check latest commit paths
    needs: check-pr-state
    runs-on: ubuntu-latest
    outputs:
      should-skip: ${{ steps.paths.outputs.should-skip }}
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Evaluate latest commit paths
        id: paths
        run: |
          python - <<'PY'
          import fnmatch
          import subprocess

          ignored = [
              '**/*.md',
              '.ai/**',
              '.claude/**',
              '.github/**',
              '.husky/**',
              '.vscode/**',
              'docs/**',
              'lib/**',
              'scripts/**',
              'commitlint.config.ts',
              '.*rc',
          ]

          output = subprocess.check_output(
              ['git', 'diff', '--name-only', 'HEAD^', 'HEAD'],
              text=True,
          )
          files = [line.strip() for line in output.splitlines() if line.strip()]

          def is_ignored(path: str) -> bool:
              return any(fnmatch.fnmatch(path, pattern) for pattern in ignored)

          should_skip = bool(files) and all(is_ignored(path) for path in files)
          print(f"Files: {files}")
          print(f"should-skip={str(should_skip).lower()}")

          with open('paths_output.txt', 'w', encoding='utf-8') as handle:
              handle.write(f"should-skip={str(should_skip).lower()}\n")
          PY

      - name: Set job output
        run: |
          cat paths_output.txt >> $GITHUB_OUTPUT

  build:
    name: Build PR
    needs:
      - check-pr-state
      - check-latest-commit
    if: needs.check-latest-commit.outputs.should-skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      statuses: write
      pull-requests: write
    steps:
      - name: Record start time
        id: start-time
        run: echo "start-time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Run TypeScript type checks
        run: |
          pnpm run dev:prepare
          pnpm run typecheck

      - name: Run affected unit tests
        id: test-unit
        run: |
          START=$(date +%s)
          node scripts/test-affected.mjs --base=origin/${{ github.base_ref }} --type=unit
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "✅ Affected unit tests completed in ${DURATION}s"

      - name: Run affected integration tests
        id: test-integration
        run: |
          START=$(date +%s)
          node scripts/test-affected.mjs --base=origin/${{ github.base_ref }} --type=integration
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "✅ Affected integration tests completed in ${DURATION}s"

      - name: Check affected E2E tests
        id: check-e2e
        run: >-
          node scripts/test-affected-check.mjs
          --base=origin/${{ github.base_ref }}
          --type=e2e

      - name: Install Playwright browsers
        if: steps.check-e2e.outputs.has-tests == 'true'
        run: pnpm exec playwright install --with-deps

      - name: Run affected E2E tests
        id: test-e2e
        if: steps.check-e2e.outputs.has-tests == 'true'
        run: |
          START=$(date +%s)
          node scripts/test-affected.mjs --base=origin/${{ github.base_ref }} --type=e2e
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "✅ Affected E2E tests completed in ${DURATION}s"
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: "!cancelled() && steps.check-e2e.outputs.has-tests == 'true'"
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Build application
        id: build-app
        env:
          ROLLDOWN_OPTIONS_VALIDATION: loose
        run: |
          START=$(date +%s)
          pnpm run build 2>&1 | tee build-output.log
          END=$(date +%s)
          DURATION=$((END - START))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "✅ Build completed in ${DURATION}s"

      - name: Extract bundle size
        id: bundle-size
        run: |
          SIZE_INFO=$(grep -E "Total size:.*MB.*gzip" build-output.log | sed 's/\x1b\[[0-9;]*m//g' | sed 's/Σ Total size: //' || echo "Size information not found")
          echo "Bundle Size: $SIZE_INFO"
          echo "bundle-size=$SIZE_INFO" >> $GITHUB_OUTPUT

      - name: Verify build output exists
        run: |
          if [ ! -d ".output" ]; then
            echo "❌ ERROR: .output/ directory not found!"
            exit 1
          fi
          echo "✅ Build successful"
          ls -lah .output/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-build
          path: .output/
          include-hidden-files: true
          if-no-files-found: error
          retention-days: 1

      - name: Get PR commit info
        if: success()
        id: pr
        run: |
          SHA="${{ github.event.pull_request.head.sha }}"
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "sha-short=$(echo "$SHA" | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Calculate total duration
        if: success()
        id: duration
        run: |
          START_TIME=${{ steps.start-time.outputs.start-time }}
          END_TIME=$(date +%s)
          TOTAL=$((END_TIME - START_TIME))
          MINUTES=$((TOTAL / 60))
          SECONDS=$((TOTAL % 60))
          if [ $MINUTES -gt 0 ]; then
            DURATION="${MINUTES}m ${SECONDS}s"
          else
            DURATION="${SECONDS}s"
          fi
          echo "total=$DURATION" >> $GITHUB_OUTPUT

      - name: Comment build results on PR
        if: success()
        uses: mshick/add-pr-comment@v2
        with:
          issue: ${{ github.event.pull_request.number }}
          allow-repeats: true
          message: |
            ## Built on <img width="16" alt="GitHub Actions" src="https://github.githubassets.com/favicons/favicon.svg"> GitHub Actions

            | Property | Value |
            |----------|-------|
            | **Author** | [@${{ github.event.pull_request.user.login }}](https://github.com/${{ github.event.pull_request.user.login }}) |
            | **Tests** | Unit: ${{ steps.test-unit.outputs.duration }} \| Integration: ${{ steps.test-integration.outputs.duration }} \| E2E: ${{ steps.test-e2e.outputs.duration || 'skipped' }} |
            | **Build** | Nuxt: ${{ steps.build-app.outputs.duration }} \| Bundle: ${{ steps.bundle-size.outputs.bundle-size }} |
            | **Total time** | ${{ steps.duration.outputs.total }} |
            | **Latest commit** | [`${{ steps.pr.outputs.sha-short }}`](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/commits/${{ steps.pr.outputs.sha }}) |

      - name: Set pending deploy status on PR
        if: success()
        run: |
          gh api "repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }}" \
            -f state=pending \
            -f context="Preview Deploy" \
            -f description="Waiting for preview deployment..."
        env:
          GH_TOKEN: ${{ github.token }}
