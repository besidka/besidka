name: Update PRs

on:
  pull_request_target:
    types: [opened]

jobs:
  update:
    name: "Update PRs"
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit messages
        id: commits
        run: |
          # Get all commit messages in the PR
          COMMIT_MESSAGES=$(git log --format="%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "messages<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MESSAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Automatically assign user to PR
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions-ecosystem/action-add-assignees@v1
        with:
          github_token: ${{ secrets.PROJECT_ACTIONS_GITHUB_TOKEN }}
          assignees: ${{ github.actor }}

      - name: Add to MVP Milestone
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: andrefcdias/add-to-milestone@v1.3.0
        continue-on-error: true
        with:
          repo-token: ${{ secrets.PROJECT_ACTIONS_GITHUB_TOKEN }}
          milestone: "MVP"

      - name: Add PR to Project
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/${{ github.repository_owner }}/projects/2
          github-token: ${{ secrets.PROJECT_ACTIONS_GITHUB_TOKEN }}

      - name: Determine labels to add
        id: labels
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          COMMIT_MESSAGES: ${{ steps.commits.outputs.messages }}
        run: |
          labels_to_add=""

          label_types=("feat" "fix" "docs" "test")

          for label in "${label_types[@]}"; do
            should_add_label=false

            if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
              if [[ "$PR_BODY" == ${label}* ]]; then
                should_add_label=true
              fi

              if [[ "$COMMIT_MESSAGES" == *"${label}:"* ]] || [[ "$COMMIT_MESSAGES" == *"${label}("* ]]; then
                should_add_label=true
              fi
            fi

            if [[ "$should_add_label" == "true" ]]; then
              if [[ -n "$labels_to_add" ]]; then
                labels_to_add="${labels_to_add},${label}"
              else
                labels_to_add="$label"
              fi
            fi
          done

          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            add_label() {
              local label="$1"

              if [[ ",$labels_to_add," == *",${label},"* ]]; then
                return
              fi

              if [[ -n "$labels_to_add" ]]; then
                labels_to_add="${labels_to_add},${label}"
              else
                labels_to_add="$label"
              fi
            }

            label_rules=(
              "dependencies:chore(deps,security(snyk)"
              "critical:security"
            )

            for rule in "${label_rules[@]}"; do
              IFS=':' read -r label patterns <<< "$rule"
              IFS=',' read -ra pattern_list <<< "$patterns"

              for pattern in "${pattern_list[@]}"; do
                if [[ "$COMMIT_MESSAGES" == *"$pattern"* ]]; then
                  add_label "$label"
                  break
                fi
              done
            done
          fi

          echo "labels=$labels_to_add" >> $GITHUB_OUTPUT

      - name: Add labels
        uses: actions-ecosystem/action-add-labels@v1
        if: steps.labels.outputs.labels != ''
        with:
          github_token: ${{ github.token }}
          labels: ${{ steps.labels.outputs.labels }}
