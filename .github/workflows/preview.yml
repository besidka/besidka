name: Deploy to Preview

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
    
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-pr-state:
    name: "Check PR state"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check if PR is still open
        run: |
          STATE=$(gh pr view ${{ github.event.pull_request.number }} --json state --jq '.state')
          echo "PR state: $STATE"

          if [ "$STATE" != "OPEN" ]; then
            echo "PR is $STATE, canceling workflow"
            gh run cancel ${{ github.run_id }}
            exit 1
          fi

          echo "PR is open, proceeding with deployment"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

  build:
    needs: check-pr-state
    uses: ./.github/workflows/build.yml
    with:
      environment: preview
      worker_name_prefix: ${{ github.event.pull_request.head.sha }}
      pr_number: ${{ github.event.pull_request.number }}
    secrets: inherit
    permissions:
      id-token: write
      contents: read
    
  comment:
    name: "Comment preview URL on PR"
    needs: build
    if: needs.build.outputs.url
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get commit information
        id: commit-info
        run: |
          echo "commit-hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit-hash-full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "pr-commit-hash=$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "pr-commit-hash-full=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          echo "commit-author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT

      - name: Comment preview URL on PR
        uses: mshick/add-pr-comment@v2
        with:
          allow-repeats: true
          message: |
            ## Deployed to <img width="16" alt="Cloudflare Workers logo" src="https://workers.cloudflare.com/logo.svg"> Cloudflare Workers

            | Property | Value |
            |----------|-------|
            | **Tests** | Unit: ${{ needs.build.outputs.test-unit-time }} \| Integration: ${{ needs.build.outputs.test-integration-time }} \| E2E: ${{ needs.build.outputs.test-e2e-time }} |
            | **Build** | Nuxt: ${{ needs.build.outputs.build-time }} \| Bundle: ${{ needs.build.outputs.bundle-size }} |
            | **Deploy** | ${{ needs.build.outputs.deploy-time }} |
            | **Total time** | ${{ needs.build.outputs.duration }} |
            | **Latest commit** | PR: [`${{ steps.commit-info.outputs.pr-commit-hash }}`](https://github.com/${{ github.repository }}/pull/${{ github.event.number }}/commits/${{ steps.commit-info.outputs.pr-commit-hash-full }}) \| Repo: [`${{ steps.commit-info.outputs.commit-hash }}`](https://github.com/${{ github.repository }}/commit/${{ steps.commit-info.outputs.commit-hash-full }}) |
            | **Author** | [${{ steps.commit-info.outputs.commit-author }}](https://github.com/${{ github.actor }}) |
            | **Preview URL (commit)** | ${{ needs.build.outputs.preview-hash-url || needs.build.outputs.url }} |
            | **Preview URL (PR)** | ${{ needs.build.outputs.preview-alias-url }} |

            ---
            _**Note**: Each commit gets a unique preview URL (auto-hash). The PR preview URL (pr-${{ github.event.number }}) updates with each commit. The main preview domain (`besidka-preview.chernenko.workers.dev`) updates when merged to main. Aliases auto-expire after 1,000 deployments._